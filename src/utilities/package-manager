# Ensures that the distros package manager is installed
# Ensures that additional package manager components are installed
# Ensures that the PACKAGE_MANAGER environment variable is set
# 
# Dependencies
requires log-writer

# We have been through this before and don't need to install/update anything
if [ "$PACKAGE_MANAGER" ]; then
    log_trace "$PACKAGE_MANAGER found"
    return 0
fi
    
# Let's first figure out what system we're on and what the package manager is
if which pacman; then
    log_trace $'We\'re on Arch'
    export PACKAGE_MANAGER=pacman
elif which brew  || [[ "$OSTYPE" == "darwin"* ]]; then
    log_trace $'We\'re on a Mac'
    export PACKAGE_MANAGER=homebrew
fi

# Install helpers and make sure everything is up to date
case "$PACKAGE_MANAGER" in
    "pacman")
        if ! which packer; then
            log_trace 'We need to make packer'
            # Make packer
        fi
        pacman -Syy
    ;;
    "homebrew")
        if ! which brew; then
            log_trace 'We need to get homebrew'
            xcode-select --install
            ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
        fi
        if ! brew list | grep brew-cask; then
            log_trace 'We need to get cask'
            brew install caskroom/cask/brew-cask
        fi

        brew update

        if brew outdated | grep brew-cask; then
            brew upgrade brew-cask
        fi
        
        brew cleanup && brew cask cleanup
    ;;
    *)
        log_error $'We couldn\'t find a package manager'
        exit 1
    ;;
esac

log_message "You have $PACKAGE_MANAGER"