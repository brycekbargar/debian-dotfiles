#!/bin/bash
# Ensures that Lastpass is installed on this system
#
requires package-manager
requires log-writer
requires pinentry-installed
requires zshrcfiles-initialized

if [ ! "$LASTPASS_USERNAME" ]; then
	log_error 'You must set $LASTPASS_USERNAME'
	exit 1
fi

if ! try_install lastpass-cli; then

    #Try manual install?

    log_error 'Something went wrong and you might not have Lastpass'
    exit 1
fi

if [ ! -e "$HOME/.lpass/session_privatekey" ]; then
    if ! lpass login $LASTPASS_USERNAME; then

        log_error 'Something went wrong and you might not have Lastpass'
        exit 1
    fi
fi

if [ ! "$ZSH_LPASS" ]; then 
  if [ -e "$HOME/.zshrcfiles/.zsh_lpass" ]; then
    log_warning 'Deleting existing lpass config'
    rm -f "$HOME/.zshrcfiles/.zsh_lpass"
  fi

  # We're copying since we are going to modify the file
  cp "$DOTFILES_DIR/applications/.zsh_lpass" "$HOME/.zshrcfiles/.zsh_lpass"
  sed -i '' "s/<username>/$LASTPASS_USERNAME/g" "$HOME/.zshrcfiles/.zsh_lpass"

  export ZSH_LPASS=yes
fi



log_message 'lpass is installed'