# Ensures that Dropbox is installed on this system
#
# Dependencies
source package-installer
source ensure-lastpass-cli
source logwriter

if [ "$DROPBOX_INSTALLED" ]; then
	log_trace "Dropbox already installed"
	return 0
fi

if ! package_installed dropbox-uploader; then
    
	log_warning $'Your package manager couldn\'t install dropbox'

    if [ ! -e /usr/bin/dropbox_uploader.sh ]; then
		# Do a manual install
		git clone https://github.com/andreafabrizi/Dropbox-Uploader/
 		sudo mv Dropbox-Uploader/dropbox_uploader.sh /usr/bin/
 		pushd /usr/bin/
	 	chmod +x dropbox_uploader.sh
 		popd
 	fi
 	rm -fdr Dropbox-Uploader

 	dropbox_uploader () {
 		/usr/bin/dropbox_uploader.sh $@
 	}
fi

# We are setting these config values from lastpass so it "just works"
if [ ! -e ~/.dropbox_uploader ]; then
	echo '' > ~/.dropbox_uploader
	echo 'APPKEY=$(lpass show --password DropboxAuth/APPKEY)' > ~/.dropbox_uploader
	echo 'APPSECRET=$(lpass show --password DropboxAuth/APPSECRET)' >> ~/.dropbox_uploader
	echo 'ACCESS_LEVEL=dropbox' >> ~/.dropbox_uploader
	echo 'OAUTH_ACCESS_TOKEN=$(lpass show --password DropboxAuth/OAUTH_ACCESS_TOKEN)' >> ~/.dropbox_uploader
	echo 'OAUTH_ACCESS_TOKEN_SECRET=$(lpass show --password DropboxAuth/OAUTH_ACCESS_TOKEN_SECRET)' >> ~/.dropbox_uploader
fi

if ! dropbox_uploader list; then

	log_error 'Something went wrong and you might not have dropbox'
	exit 1
fi

export DROPBOX_INSTALLED="true"
log_message 'Latest dropbox-uploader version installed'